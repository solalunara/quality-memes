<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Quality Memes</title>
    </head>
    <body>
        <div id="login-page">
            <h2>Login</h2>

            <form method="POST" onsubmit="submitform(this); return false;">
                <label for="username">*Username:</label> <input type="text" id="username" name="username" autocomplete="username" required>

                <label for="password">*Password:</label> <input type="password" id="password" name="password" autocomplete="current-password" required>

                <label for="authtoken">Authtoken:</label> <input type="text" id="authtoken" name="authtoken"></input>

                <button type="submit">Log In</button> <button type="submit" onclick="register(this.parentElement)">Register</button>
            </form>
            <div id="username-error" style="display: none;">No user exists with that username</div>
            <div id="password-error" style="display: none;">The password you entered is incorrect</div>

            If you do not enter a valid github personal access token,
            you will instead be linked to the issues page for requests like registration

        </div>

        <link rel="stylesheet" href="https://necolas.github.io/normalize.css/8.0.1/normalize.css">
        <style>
            body {
                display: flex;
                text-align: center;
                justify-content: center;
                align-items: center;
                background-image: -webkit-linear-gradient(top, #beb1a8 0%, #3680a7 100%);
                background-image: -moz-linear-gradient(top, #beb1a8 0%, #3680a7 100%);
                background-image: -ms-linear-gradient(top, #beb1a8 0%, #3680a7 100%);
                background-image: -o-linear-gradient(top, #beb1a8 0%, #3680a7 100%);
                background-image: linear-gradient(top, #beb1a8 0%, #3680a7 100%);
                min-height: 100vh;
                height: auto;
            }
            html, body {
                margin: 0;
                overflow: scroll;
            }

            #login-page {
                white-space: pre-line;
                height: auto;
                width: auto;
                text-shadow: 2px 2px 2px gray;
                font-size: 20px
            }

            button, textarea {
                text-decoration: none;
            }
            button {
                text-align: center;
                border: none;
                background-color: #2c91df;
                color: white;
                border-radius: 20px;
                transition-duration: 0.4s;
                cursor: pointer;
                padding: 5px;
            }
            input {
                background-color: #3680b7;
                color: black;
                box-shadow: 0 12px 16px 0 rgba(0,0,0,0.24), 0 17px 50px 0 rgba(0,0,0,0.19);
                resize: none;
                text-align: left;
            }
            button:hover {
                background-color: #ffffff;
                color: black;
                box-shadow: 0 12px 16px 0 rgba(0,0,0,0.24), 0 17px 50px 0 rgba(0,0,0,0.19);
            }

            .footer {
                position: fixed;
                display: block;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
            }
        </style>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
        <script type="module">
            import { Octokit } from "https://esm.sh/@octokit/core";
            async function createissue( title, body, authtoken ) {
                // Octokit.js
                // https://github.com/octokit/core.js#readme
                const octokit = new Octokit({
                    auth: authtoken
                });

                try {
                    var result = await octokit.request('POST /repos/solalunara/quality-memes/issues', {
                        owner: 'solalunara',
                        repo: 'quality-memes',
                        title: title,
                        body: body,
                        headers: {
                            'X-GitHub-Api-Version': '2022-11-28'
                        }
                    });
                    return result.status === 201;

                } catch (error) {
                    return false;
                }
            }
            window.createissue = createissue;
        </script>

        <script>
            function checkkey( event ) {
                if ( event.key === 'Enter' ) {
                    event.preventDefault();
                    rojf();
                }
            }

            // registering still needs to submit the form to save the password on firefox
            // but don't run any login code
            var registering = false;
            async function register( form ) {
                registering = true;
                var uname = form.username.value;
                var pwd = form.password.value;
                var authtoken = form.authtoken.value;
                var pwd_hash = CryptoJS.SHA256( pwd ).toString();
                body =  '{\
                    \"uname\": \"'+uname+'\",\
                    \"hash\": \"'+pwd_hash+'\"\
                }'
                var success = await createissue( 'Registration Request', body, authtoken );
                console.log( success );
                if ( !success )
                    window.open( 'https://github.com/solalunara/quality-memes/issues/new?title=Registration+Request&body=' + body, '_blank' );
            }

            var uname;
            var pwd;
            var authtoken;
            async function submitform( form ) {
                document.getElementById( 'username-error' ).style.display = 'none';
                document.getElementById( 'password-error' ).style.display = 'none';

                if ( registering ) {
                    registering = false;
                    return;
                }
                uname = form.username.value;
                pwd = form.password.value;
                authtoken = form.authtoken.value;
                var pwd_hash = CryptoJS.SHA256( pwd ).toString();

                var users_txt = await (await fetch( "https://solalunara.github.io/quality-memes/users.json" )).text()
                var users = JSON.parse( users_txt );
                var user = users[ uname ];
                if ( user === undefined ) {
                    document.getElementById( 'username-error' ).style.display = '';
                    return;
                }
            }
        </script>
    </body>

</html>